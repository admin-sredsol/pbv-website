---
import BaseLayout from "../../layouts/BaseLayout.astro";
import InnerHero from "../../components/sections/InnerHero.astro";
import { listR2Albums, listR2AlbumFiles } from "../../utils/r2";
import heroBg from "../../assets/InnerHero-bg.jpg"; // Adjust path as needed
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";
import { getBreadcrumbs } from "../../utils/getBreadcrumbs";

export async function getStaticPaths() {
    const bucket = "website-gallery";
    const albumsPrefix = "videoalbums/";
    const albumPrefixes = await listR2Albums(bucket, albumsPrefix);

    return albumPrefixes.map((prefix) => ({
        params: {
            videoalbum: prefix.replace(/^videoalbums\//, "").replace(/\/$/, ""),
        },
    }));
}

const { videoalbum } = Astro.params;
const bucket = "website-gallery";
const albumPrefix = `videoalbums/${videoalbum}/`;

const videos = await listR2AlbumFiles(bucket, albumPrefix);
const label = videoalbum.replace(/[-_]/g, " ");
const breadcrumbs = getBreadcrumbs(Astro.url.pathname);
---

<BaseLayout>
    <InnerHero
        content={{
            title: label,
            description: `Videos from the ${label} album.`,
            backgroundImage: heroBg,
            overlayOpacity: 0.6,
        }}
    />

    <div class="max-w-6xl mx-auto px-4 py-6">
        <Breadcrumbs crumbs={breadcrumbs} />
        {
            videos.length === 0 ? (
                <p class="text-center text-gray-500">
                    No videos found in this album.
                </p>
            ) : (
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    {videos.map((video) => (
                        <div class="overflow-hidden rounded-lg bg-white shadow aspect-video flex flex-col">
                            <video
                                src={video.url}
                                controls
                                class="w-full h-full object-cover"
                                preload="metadata"
                                title={video.key}
                            />
                            <div class="p-2 text-center text-sm text-gray-700">
                                {video.key
                                    .replace(albumPrefix, "")
                                    .replace(/\.[^/.]+$/, "")}
                            </div>
                        </div>
                    ))}
                </div>
            )
        }
    </div>
</BaseLayout>
