---
import BaseLayout from "../../layouts/BaseLayout.astro";
import SectionHeader from "../../components/academics/SectionHeader.astro";
import { academicsSample } from "../../data/academics/sample";

const { subjects } = academicsSample;

const headerContent = {
    eyebrow: "Academics",
    title: "Subjects",
    description:
        "Browse subjects offered across our AP and State Board curricula. Click a subject to see details, topics and resources.",
    button: {
        text: "View calendar",
        link: "/academics/academic-calendar",
        variant: "ghostLight",
    },
} as const;
---

<BaseLayout>
    <main class="site-container px-4 py-12">
        <SectionHeader content={headerContent} />

        <section class="mt-10">
            <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6"
            >
                <div class="flex items-center gap-3">
                    <label for="subject-search" class="sr-only"
                        >Search subjects</label
                    >
                    <input
                        id="subject-search"
                        type="search"
                        placeholder="Search subjects (e.g. Mathematics, Physics)"
                        class="px-4 py-2 rounded border border-black w-full md:w-80 bg-input text-input-text"
                    />

                    <div
                        class="hidden md:block border-l border-black/10 h-6 mx-4"
                    >
                    </div>

                    <div class="flex gap-2">
                        <button
                            type="button"
                            data-filter="all"
                            class="px-3 py-2 rounded bg-primary text-white"
                            >All</button
                        >
                        <button
                            type="button"
                            data-filter="ap"
                            class="px-3 py-2 rounded border border-black bg-background/90"
                            >AP eligible</button
                        >
                        <button
                            type="button"
                            data-filter="state"
                            class="px-3 py-2 rounded border border-black bg-background/90"
                            >State board</button
                        >
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <a class="text-sm underline" href="/academics/subjects"
                        >Subjects index</a
                    >
                    <a class="text-sm underline" href="/academics/resources"
                        >Resources</a
                    >
                </div>
            </div>

            <div
                id="subjects-grid"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
            >
                {
                    subjects.map((s) => (
                        <article
                            class="p-5 rounded-lg border border-black bg-background/90"
                            data-subject-slug={s.slug}
                            data-ap={s.apEligible ? "true" : "false"}
                            data-title={s.title.toLowerCase()}
                        >
                            <div class="flex items-start justify-between">
                                <div class="min-w-0">
                                    <h3 class="text-h5 font-semibold mb-1">
                                        {s.title}
                                    </h3>
                                    {s.description && (
                                        <p class="text-sm opacity-90 line-clamp-3">
                                            {s.description}
                                        </p>
                                    )}
                                </div>

                                <div class="text-sm text-right ml-4">
                                    {s.apEligible ? (
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-primary/10 text-primary">
                                            AP
                                        </span>
                                    ) : (
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-surface/60 text-muted">
                                            State
                                        </span>
                                    )}
                                </div>
                            </div>

                            <div class="mt-4 flex items-center justify-between">
                                <a
                                    href={`/academics/subject/${s.slug}`}
                                    class="inline-flex items-center px-4 py-2 rounded bg-primary text-white"
                                >
                                    View subject
                                </a>
                                <a
                                    href={`/academics/grade/overview`}
                                    class="text-sm underline opacity-80"
                                >
                                    Grade mapping
                                </a>
                            </div>
                        </article>
                    ))
                }
            </div>

            <div class="mt-8 text-sm opacity-80">
                <p>
                    Quick links: Grade pages â€”
                    <a class="underline ml-1 mr-1" href="/academics/grade/6"
                        >Grade 6</a
                    >|
                    <a class="underline ml-1 mr-1" href="/academics/grade/7"
                        >Grade 7</a
                    >|
                    <a class="underline ml-1 mr-1" href="/academics/grade/8"
                        >Grade 8</a
                    >|
                    <a class="underline ml-1" href="/academics/grade/11"
                        >Grade 11</a
                    >
                </p>
            </div>
        </section>
    </main>

    <script type="module">
        (function () {
            if (typeof document === "undefined") return;

            const grid = document.getElementById("subjects-grid");
            const search = document.getElementById("subject-search");
            const filterButtons = Array.from(
                document.querySelectorAll("[data-filter]"),
            );

            function applyFilter() {
                const query = (search.value || "").trim().toLowerCase();
                const active =
                    filterButtons.find(
                        (b) =>
                            b.classList.contains("bg-primary") ||
                            b.classList.contains("!bg-primary"),
                    ) || document.querySelector('[data-filter="all"]');

                // Determine filter mode
                let mode = "all";
                for (const b of filterButtons) {
                    if (
                        b.classList.contains("bg-primary") ||
                        b.classList.contains("!bg-primary")
                    ) {
                        mode = b.getAttribute("data-filter") || "all";
                        break;
                    }
                }

                const items = grid.querySelectorAll("[data-subject-slug]");
                items.forEach((item) => {
                    const title = item.getAttribute("data-title") || "";
                    const ap = item.getAttribute("data-ap") === "true";
                    let visible = true;

                    if (mode === "ap" && !ap) visible = false;
                    if (mode === "state" && ap) visible = false;
                    if (query && !title.includes(query)) visible = false;

                    item.style.display = visible ? "" : "none";
                });
            }

            // Attach events
            search.addEventListener("input", () => applyFilter());

            filterButtons.forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    // toggle active styling: simple approach - remove from all, add to clicked (single-select)
                    filterButtons.forEach((b) => {
                        b.classList.remove("bg-primary", "text-white");
                        b.classList.add("bg-background/90");
                    });
                    btn.classList.add("bg-primary", "text-white");
                    btn.classList.remove("bg-background/90");
                    applyFilter();
                });
            });

            // initialize: select "all"
            const allBtn = document.querySelector('[data-filter="all"]');
            if (allBtn) {
                allBtn.classList.add("bg-primary", "text-white");
            }
            applyFilter();
        })();
    </script>
</BaseLayout>
